<?xml version="1.0"?>
<psalm
    errorLevel="4"
    resolveFromConfigFile="true"
    findUnusedBaselineEntry="true"
    findUnusedCode="true"
    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xmlns="https://getpsalm.org/schema/config"
    xsi:schemaLocation="https://getpsalm.org/schema/config vendor/vimeo/psalm/config.xsd"
>
    <stubs>
        <file name=".psalm/stubs.php" />
    </stubs>
    <projectFiles>
        <directory name="." />
        <ignoreFiles>
            <directory name="vendor" />
            <directory name="node_modules" />
            <!-- Generated/minified assets -->
            <directory name="assets" />
            <!-- Documentation -->
            <directory name="docs" />
            <!-- Build tools -->
            <directory name="src/tools" />
            <!-- Psalm stubs directory -->
            <directory name=".psalm" />
            <!-- Test files - excluded from unused code checks -->
            <directory name="tests" />
        </ignoreFiles>
    </projectFiles>

    <globals>
        <!-- Database globals from db_bootstrap.php -->
        <var name="$tbpref" type="string" />
        <!-- Debug mode from debug_utilities.php -->
        <var name="$debug" type="bool" />
        <!-- Alternative table prefix used in some contexts -->
        <var name="$fixed_tbpref" type="string" />
    </globals>

    <issueHandlers>
        <!--
            =================================================================
            UNDEFINED REFERENCES
            These directories use functions, constants, classes and variables
            that are defined at runtime through includes.
            =================================================================
        -->
        <UndefinedGlobalVariable>
            <errorLevel type="suppress">
                <directory name="src/backend/Views" />
            </errorLevel>
        </UndefinedGlobalVariable>

        <UndefinedFunction>
            <errorLevel type="suppress">
                <directory name="src/backend/Api" />
                <directory name="src/backend/Views" />
                <directory name="src/backend/Services" />
                <directory name="src/backend/Controllers" />
                <directory name="src/backend/Core" />
            </errorLevel>
        </UndefinedFunction>

        <UndefinedConstant>
            <errorLevel type="suppress">
                <directory name="src/backend/Views" />
                <directory name="src/backend/Api" />
            </errorLevel>
        </UndefinedConstant>

        <UndefinedClass>
            <errorLevel type="suppress">
                <directory name="src/backend/Api" />
                <directory name="src/backend/Core/Database" />
                <directory name="src/backend/Services" />
                <directory name="src/backend/Views" />
            </errorLevel>
        </UndefinedClass>

        <UndefinedVariable>
            <errorLevel type="suppress">
                <directory name="tests/backend" />
            </errorLevel>
        </UndefinedVariable>

        <!--
            =================================================================
            TYPE MISMATCHES
            These directories handle dynamically typed data from databases,
            forms, and legacy code.
            =================================================================
        -->
        <TypeDoesNotContainType>
            <errorLevel type="suppress">
                <directory name="src/backend/Api" />
                <directory name="src/backend/Views" />
                <directory name="src/backend/Controllers" />
                <directory name="tests/backend" />
            </errorLevel>
        </TypeDoesNotContainType>

        <TypeDoesNotContainNull>
            <errorLevel type="suppress">
                <directory name="src/backend/Views" />
            </errorLevel>
        </TypeDoesNotContainNull>

        <InvalidScalarArgument>
            <errorLevel type="suppress">
                <directory name="src/backend/Views" />
                <directory name="src/backend/Controllers" />
                <directory name="src/backend/Services" />
                <directory name="tests/backend" />
            </errorLevel>
        </InvalidScalarArgument>

        <InvalidArgument>
            <errorLevel type="suppress">
                <directory name="src/backend/Controllers" />
                <directory name="tests/backend" />
            </errorLevel>
        </InvalidArgument>

        <!--
            =================================================================
            RETURN TYPE ISSUES
            Legacy code and controllers have complex return type patterns.
            =================================================================
        -->
        <InvalidReturnType>
            <errorLevel type="suppress">
                <directory name="src/backend/Controllers" />
                <directory name="src/backend/Services" />
                <directory name="tests/backend" />
            </errorLevel>
        </InvalidReturnType>

        <InvalidReturnStatement>
            <errorLevel type="suppress">
                <directory name="src/backend/Controllers" />
                <directory name="src/backend/Services" />
                <directory name="tests/backend" />
            </errorLevel>
        </InvalidReturnStatement>

        <NoValue>
            <errorLevel type="suppress">
                <directory name="src/backend/Api" />
                <directory name="src/backend/Controllers" />
                <directory name="src/backend/Services" />
            </errorLevel>
        </NoValue>

        <!--
            =================================================================
            ARGUMENT COUNT ISSUES
            Legacy code uses functions with varying argument patterns.
            =================================================================
        -->
        <TooFewArguments>
            <errorLevel type="suppress">
                <directory name="tests/backend" />
            </errorLevel>
        </TooFewArguments>

        <TooManyArguments>
            <errorLevel type="suppress">
                <directory name="src/backend/Api" />
                <directory name="src/backend/Core" />
                <directory name="src/backend/Controllers" />
                <directory name="src/backend/Services" />
                <directory name="tests/backend" />
            </errorLevel>
        </TooManyArguments>

        <!--
            =================================================================
            UNUSED CODE
            Controllers pass variables to views; API handlers use SQL interpolation;
            Legacy code has refactoring artifacts.
            =================================================================
        -->
        <UnusedVariable>
            <errorLevel type="suppress">
                <directory name="src/backend/Controllers" />
                <directory name="src/backend/Api" />
                <directory name="src/backend/Views" />
                <directory name="src/backend/Services" />
                <directory name="tests/backend" />
                <file name="index.php" />
                <file name="src/backend/Core/Bootstrap/db_bootstrap.php" />
                <file name="src/backend/Core/Integration/wp_logincheck.php" />
            </errorLevel>
        </UnusedVariable>

        <UnusedParam>
            <errorLevel type="suppress">
                <directory name="src/backend/Controllers" />
            </errorLevel>
        </UnusedParam>

        <PossiblyUnusedParam>
            <errorLevel type="suppress">
                <directory name="src/backend/Controllers" />
                <directory name="src/backend/Services" />
                <directory name="src/backend/View" />
            </errorLevel>
        </PossiblyUnusedParam>

        <UnusedForeachValue>
            <errorLevel type="suppress">
                <directory name="src/backend/Api" />
                <directory name="src/backend/Services" />
            </errorLevel>
        </UnusedForeachValue>

        <PossiblyUnusedMethod>
            <errorLevel type="suppress">
                <directory name="src/backend/Controllers" />
                <directory name="src/backend/Views" />
                <directory name="src/backend/View" />
                <directory name="src/backend/Core" />
                <directory name="src/backend/Api" />
                <directory name="src/backend/Services" />
            </errorLevel>
        </PossiblyUnusedMethod>

        <PossiblyUnusedReturnValue>
            <errorLevel type="suppress">
                <directory name="src/backend/Services" />
            </errorLevel>
        </PossiblyUnusedReturnValue>

        <PossiblyUnusedProperty>
            <errorLevel type="suppress">
                <directory name="src/backend/Core/Entity" />
                <directory name="src/backend/Controllers" />
            </errorLevel>
        </PossiblyUnusedProperty>

        <UnusedClass>
            <errorLevel type="suppress">
                <directory name="tests/backend" />
                <directory name="src/backend/Controllers" />
                <directory name="src/backend/Core/Entity" />
                <file name="src/backend/Core/Database/DB.php" />
            </errorLevel>
        </UnusedClass>

        <UnusedMethodCall>
            <errorLevel type="suppress">
                <directory name="tests/backend" />
            </errorLevel>
        </UnusedMethodCall>

        <UnusedFunctionCall>
            <errorLevel type="suppress">
                <directory name="tests/backend" />
                <directory name="src/backend/Services" />
            </errorLevel>
        </UnusedFunctionCall>

        <!--
            =================================================================
            ARRAY AND OPERAND ISSUES
            Legacy code accesses arrays dynamically.
            =================================================================
        -->
        <InvalidArrayOffset>
            <errorLevel type="suppress">
                <directory name="src/backend/Services" />
                <directory name="tests/backend" />
            </errorLevel>
        </InvalidArrayOffset>

        <!--
            =================================================================
            GLOBAL SCOPE
            Legacy files use global scope for script-level code.
            =================================================================
        -->
        <InvalidGlobal>
            <errorLevel type="suppress">
                <file name="src/backend/Core/Bootstrap/db_bootstrap.php" />
            </errorLevel>
        </InvalidGlobal>

        <!--
            =================================================================
            DOCUMENTATION ISSUES
            Legacy and view files may have outdated or unnecessary annotations.
            =================================================================
        -->
        <UnnecessaryVarAnnotation>
            <errorLevel type="suppress">
                <directory name="src/backend/Views" />
            </errorLevel>
        </UnnecessaryVarAnnotation>

        <MismatchingDocblockParamType>
            <errorLevel type="suppress">
                <directory name="src/backend/Views" />
            </errorLevel>
        </MismatchingDocblockParamType>

        <!--
            =================================================================
            CAST AND CONDITION ISSUES
            Explicit casts and conditions kept for clarity in legacy code.
            =================================================================
        -->
        <RedundantCast>
            <errorLevel type="suppress">
                <directory name="src/backend/Views" />
                <directory name="src/backend/Services" />
                <directory name="src/backend/Core/Database" />
            </errorLevel>
        </RedundantCast>

        <RedundantCondition>
            <errorLevel type="suppress">
                <directory name="tests/backend" />
                <directory name="src/backend/Views" />
                <directory name="src/backend/Controllers" />
                <directory name="src/backend/Services" />
                <file name="src/backend/Core/Database/TextParsing.php" />
            </errorLevel>
        </RedundantCondition>

        <!--
            =================================================================
            FILE AND CODE FLOW
            Files may be reorganized; code may exit early.
            =================================================================
        -->
        <MissingFile>
            <errorLevel type="suppress">
                <directory name="src/backend/Controllers" />
                <file name="index.php" />
            </errorLevel>
        </MissingFile>

        <UnevaluatedCode>
            <errorLevel type="suppress">
                <directory name="src/backend/Controllers" />
            </errorLevel>
        </UnevaluatedCode>

        <!--
            =================================================================
            INTERFACE AND SECURITY
            =================================================================
        -->
        <UndefinedInterfaceMethod>
            <errorLevel type="suppress">
                <directory name="tests/backend" />
            </errorLevel>
        </UndefinedInterfaceMethod>

        <ForbiddenCode>
            <errorLevel type="suppress">
                <directory name="tests/backend" />
                <file name="src/backend/Services/TextParsingService.php" />
            </errorLevel>
        </ForbiddenCode>

        <!--
            =================================================================
            SERVICES TYPE ISSUES
            Services handle database results with mixed types and edge cases.
            =================================================================
        -->
        <InvalidCast>
            <errorLevel type="suppress">
                <directory name="src/backend/Services" />
            </errorLevel>
        </InvalidCast>

        <UndefinedPropertyFetch>
            <errorLevel type="suppress">
                <!-- DOMNameSpaceNode is a special XML node type -->
                <directory name="src/backend/Services" />
            </errorLevel>
        </UndefinedPropertyFetch>

        <!--
            Views included from controllers use $this from the controller context.
        -->
        <InvalidScope>
            <errorLevel type="suppress">
                <directory name="src/backend/Views" />
            </errorLevel>
        </InvalidScope>

    </issueHandlers>
</psalm>
