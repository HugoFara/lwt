<?xml version="1.0"?>
<psalm
    errorLevel="4"
    resolveFromConfigFile="true"
    findUnusedBaselineEntry="true"
    findUnusedCode="true"
    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xmlns="https://getpsalm.org/schema/config"
    xsi:schemaLocation="https://getpsalm.org/schema/config vendor/vimeo/psalm/config.xsd"
>
    <stubs>
        <file name=".psalm/stubs.php" />
    </stubs>
    <projectFiles>
        <directory name="." />
        <ignoreFiles>
            <directory name="vendor" />
            <directory name="node_modules" />
            <directory name="assets" />
            <directory name="docs" />
            <directory name="src/tools" />
            <directory name=".psalm" />
            <directory name="tests" />
        </ignoreFiles>
    </projectFiles>

    <issueHandlers>
        <!-- Views use variables passed from controllers via extract() -->
        <UndefinedGlobalVariable>
            <errorLevel type="suppress">
                <directory name="src/backend/Views" />
            </errorLevel>
        </UndefinedGlobalVariable>

        <!-- Views use $this from controller context when included -->
        <InvalidScope>
            <errorLevel type="suppress">
                <directory name="src/backend/Views" />
            </errorLevel>
        </InvalidScope>

        <!-- Controllers pass variables to views, services have template vars -->
        <UnusedVariable>
            <errorLevel type="suppress">
                <directory name="src/backend/Controllers" />
                <directory name="src/backend/Views" />
                <directory name="src/backend/Services" />
            </errorLevel>
        </UnusedVariable>

        <!-- Methods may have unused params for interface conformance or future use -->
        <PossiblyUnusedParam>
            <errorLevel type="suppress">
                <directory name="src/backend/Controllers" />
                <directory name="src/backend/Services" />
                <directory name="src/backend/View" />
                <directory name="src/backend/Core" />
            </errorLevel>
        </PossiblyUnusedParam>

        <UnusedParam>
            <errorLevel type="suppress">
                <directory name="src/backend/Controllers" />
            </errorLevel>
        </UnusedParam>

        <!-- Public methods called via routing or kept for API completeness -->
        <PossiblyUnusedMethod>
            <errorLevel type="suppress">
                <directory name="src/backend/Controllers" />
                <directory name="src/backend/Api" />
                <directory name="src/backend/Core" />
                <directory name="src/backend/Services" />
                <directory name="src/backend/View" />
            </errorLevel>
        </PossiblyUnusedMethod>

        <!-- Properties set from database results or declared for future use -->
        <PossiblyUnusedProperty>
            <errorLevel type="suppress">
                <directory name="src/backend/Core/Entity" />
                <directory name="src/backend/Controllers" />
            </errorLevel>
        </PossiblyUnusedProperty>

        <!-- Classes instantiated by router or kept for API completeness -->
        <UnusedClass>
            <errorLevel type="suppress">
                <directory name="src/backend/Controllers" />
                <directory name="src/backend/Core/Entity" />
            </errorLevel>
        </UnusedClass>

        <!-- Legacy files may be missing during refactoring -->
        <MissingFile>
            <errorLevel type="suppress">
                <directory name="src/backend/Controllers" />
            </errorLevel>
        </MissingFile>

        <!-- Views call global functions that may be dynamically loaded -->
        <UndefinedFunction>
            <errorLevel type="suppress">
                <directory name="src/backend/Views" />
            </errorLevel>
        </UndefinedFunction>

        <!-- Defensive null/type checks for safety with dynamic data -->
        <RedundantCondition>
            <errorLevel type="suppress">
                <directory name="src/backend/Views" />
                <directory name="src/backend/Services" />
                <directory name="src/backend/Core" />
            </errorLevel>
        </RedundantCondition>

        <TypeDoesNotContainNull>
            <errorLevel type="suppress">
                <directory name="src/backend/Views" />
            </errorLevel>
        </TypeDoesNotContainNull>

        <TypeDoesNotContainType>
            <errorLevel type="suppress">
                <directory name="src/backend/Views" />
            </errorLevel>
        </TypeDoesNotContainType>

        <!-- Defensive casts for type safety with dynamic data -->
        <RedundantCast>
            <errorLevel type="suppress">
                <directory name="src/backend/Views" />
                <directory name="src/backend/Services" />
                <directory name="src/backend/Core" />
            </errorLevel>
        </RedundantCast>

        <!-- Return value may not be used by callers -->
        <PossiblyUnusedReturnValue>
            <errorLevel type="suppress">
                <directory name="src/backend/Services" />
            </errorLevel>
        </PossiblyUnusedReturnValue>

        <!-- Services handle data from various sources with different types -->
        <InvalidReturnType>
            <errorLevel type="suppress">
                <directory name="src/backend/Services" />
            </errorLevel>
        </InvalidReturnType>

        <InvalidReturnStatement>
            <errorLevel type="suppress">
                <directory name="src/backend/Services" />
            </errorLevel>
        </InvalidReturnStatement>

        <!-- Foreach values used for iteration control only -->
        <UnusedForeachValue>
            <errorLevel type="suppress">
                <directory name="src/backend/Services" />
                <directory name="src/backend/Controllers" />
            </errorLevel>
        </UnusedForeachValue>

        <!-- DOMNameSpaceNode has attributes in practice -->
        <UndefinedPropertyFetch>
            <errorLevel type="suppress">
                <directory name="src/backend/Services" />
            </errorLevel>
        </UndefinedPropertyFetch>

        <!-- Dynamic array access patterns -->
        <InvalidArrayOffset>
            <errorLevel type="suppress">
                <directory name="src/backend/Services" />
            </errorLevel>
        </InvalidArrayOffset>

        <!-- Unused function calls that have side effects -->
        <UnusedFunctionCall>
            <errorLevel type="suppress">
                <directory name="src/backend/Services" />
            </errorLevel>
        </UnusedFunctionCall>

        <!-- Var annotations for clarity in views/controllers -->
        <UnnecessaryVarAnnotation>
            <errorLevel type="suppress">
                <directory name="src/backend/Views" />
                <directory name="src/backend/Controllers" />
            </errorLevel>
        </UnnecessaryVarAnnotation>

        <!-- shell_exec used for feature detection (MeCab) -->
        <ForbiddenCode>
            <errorLevel type="suppress">
                <directory name="src/backend/Services" />
            </errorLevel>
        </ForbiddenCode>
    </issueHandlers>
</psalm>
